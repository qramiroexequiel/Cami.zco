{% extends 'dashboard/base.html' %}

{% block title %}Pedidos - Panel de AdministraciÃ³n{% endblock %}

{% block dashboard_content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Pedidos</h1>
</div>

<!-- Filtro por estado -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <form method="get" class="flex items-center space-x-4">
        <label class="text-sm font-medium text-gray-700">Filtrar por estado:</label>
        <select name="estado" onchange="this.form.submit()" class="form-input">
            <option value="">Todos</option>
            {% for estado_val, estado_label in estados %}
            <option value="{{ estado_val }}" {% if estado_filtro == estado_val %}selected{% endif %}>
                {{ estado_label }}
            </option>
            {% endfor %}
        </select>
    </form>
</div>

<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for pedido in pedidos %}
                <tr>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">{{ pedido.nombre }}</div>
                        <div class="text-sm text-gray-500">{{ pedido.whatsapp }}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ pedido.producto.titulo|default:"Personalizado" }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ pedido.cantidad }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ pedido.fecha_creacion|date:"d/m/Y" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <form method="post" action="{% url 'dashboard:pedido_actualizar_estado' pedido.id %}" class="inline">
                            {% csrf_token %}
                            <select name="estado" onchange="this.form.submit()" class="text-xs font-semibold rounded-full px-3 py-1 border-0
                                {% if pedido.estado == 'nuevo' %}bg-blue-100 text-blue-800
                                {% elif pedido.estado == 'confirmado' %}bg-yellow-100 text-yellow-800
                                {% elif pedido.estado == 'en_produccion' %}bg-pink-100 text-pink-800
                                {% elif pedido.estado == 'listo' %}bg-green-100 text-green-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% for estado_val, estado_label in estados %}
                                <option value="{{ estado_val }}" {% if pedido.estado == estado_val %}selected{% endif %}>
                                    {{ estado_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="mostrarDetalles({{ pedido.id }})" class="text-indigo-600 hover:text-indigo-900 mr-4">
                            Ver
                        </button>
                    </td>
                </tr>
                
                <!-- Detalles del pedido (oculto por defecto) -->
                <tr id="detalles-{{ pedido.id }}" class="hidden">
                    <td colspan="6" class="px-6 py-4 bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">InformaciÃ³n del pedido</h4>
                                <p class="text-sm"><strong>Texto a grabar:</strong> {{ pedido.texto_tallar|default:"No especificado" }}</p>
                                <p class="text-sm"><strong>Entrega:</strong> {{ pedido.get_entrega_display }}{% if pedido.zona_ciudad %} - {{ pedido.zona_ciudad }}{% endif %}</p>
                                {% if pedido.fecha_para_cuando %}
                                <p class="text-sm"><strong>Para cuÃ¡ndo:</strong> {{ pedido.fecha_para_cuando|date:"d/m/Y" }}</p>
                                {% endif %}
                                {% if pedido.notas %}
                                <p class="text-sm"><strong>Notas del cliente:</strong> {{ pedido.notas }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Notas internas</h4>
                                <form method="post" action="{% url 'dashboard:pedido_actualizar_notas' pedido.id %}">
                                    {% csrf_token %}
                                    <textarea name="notas_internas" rows="3" class="form-textarea w-full">{{ pedido.notas_internas }}</textarea>
                                    <button type="submit" class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm">
                                        Guardar notas
                                    </button>
                                </form>
                                <div class="mt-4 space-y-2">
                                    <button onclick="copiarMensajeWhatsApp('{{ pedido.nombre }}', '{{ pedido.producto.titulo|default:"Personalizado" }}')" 
                                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm w-full">
                                        ðŸ“‹ Copiar mensaje WhatsApp
                                    </button>
                                    <a href="https://wa.me/{{ whatsapp_destino }}?text={{ pedido.get_mensaje_whatsapp }}" 
                                       target="_blank" 
                                       rel="noopener noreferrer"
                                       class="block bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm text-center">
                                        ðŸ’¬ Abrir WhatsApp
                                    </a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        No hay pedidos aÃºn.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function mostrarDetalles(pedidoId) {
    const detalles = document.getElementById('detalles-' + pedidoId);
    detalles.classList.toggle('hidden');
}

function copiarMensajeWhatsApp(nombre, producto) {
    const mensaje = `Hola ${nombre}, recibimos tu pedido de ${producto} ðŸ’›`;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(mensaje).then(() => {
            alert('Mensaje copiado al portapapeles');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const textarea = document.createElement('textarea');
            textarea.value = mensaje;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Mensaje copiado al portapapeles');
        });
    } else {
        // Fallback para navegadores antiguos
        const textarea = document.createElement('textarea');
        textarea.value = mensaje;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Mensaje copiado al portapapeles');
    }
}
</script>
{% endblock %}

